/*!
 * @file fsk_rt.c
 *
 * @brief
 *
 * @author ECE486 Lab Group 9
 * @author Colin Leary
 * @author Forrest Smith
 * @author Sean Turner
 *
 * @date April 23, 2016
 *
 */
#include <stdint.h>
#include <math.h>
#include "arm_math.h"
#include "arm_const_structs.h"
#include "ece486_fft.h"
#include "ece486.h"

void peak_detect(float *data, float thresh, float *farthest_peak_index)
{
	int i;
	float index = 0;
	int count = 0;
	float peaks[FFTSAMPLES] = {0};//detects 10 peaks


	for (i = 1; i < FFTSAMPLES-1; i++) {
		if ((data[i] >= thresh) && (data[i-1] < data[i]) && (data[i+1] < data[i])){
			peaks[count++] = i+1; //can probably simplify this
		}
	}



	for (i = 0; i < count; i++){
		if (peaks[i] > index) index = peaks[i];
	}

	*farthest_peak_index = index;

}


void fft(float *buffer, float thresh, float *peak_index)
{
	static float output[FFTSAMPLES] = {0};
	int ifftFlag = 0;
	int doBitReverse = 1;

	//set up for a 512 blocksize and fft of 512
	arm_cfft_f32(&arm_cfft_sR_f32_len1024, buffer, ifftFlag, doBitReverse);
	arm_cmplx_mag_f32(buffer, output, FFTSAMPLES*2);
	peak_detect(output, thresh, peak_index);

}

//multiply by 512 samples of a half period of sine, as a window function
void window(float *input)
{
	int i;

	static float lookup_table[1024] =
	{
		0.000000, 0.003071, 0.006142, 0.009213, 0.012284, 0.015354, 0.018425, 0.021495, 0.024565, 0.027635,
		0.030705, 0.033774, 0.036843, 0.039912, 0.042980, 0.046048, 0.049116, 0.052183, 0.055249, 0.058315,
		0.061381, 0.064445, 0.067510, 0.070573, 0.073636, 0.076699, 0.079760, 0.082821, 0.085881, 0.088940,
		0.091999, 0.095056, 0.098113, 0.101168, 0.104223, 0.107277, 0.110330, 0.113381, 0.116432, 0.119481,
		0.122530, 0.125577, 0.128623, 0.131668, 0.134711, 0.137754, 0.140795, 0.143835, 0.146873, 0.149910,
		0.152945, 0.155979, 0.159012, 0.162043, 0.165073, 0.168101, 0.171127, 0.174152, 0.177175, 0.180197,
		0.183217, 0.186235, 0.189251, 0.192266, 0.195279, 0.198289, 0.201299, 0.204306, 0.207311, 0.210314,
		0.213315, 0.216315, 0.219312, 0.222307, 0.225300, 0.228291, 0.231280, 0.234266, 0.237251, 0.240233,
		0.243213, 0.246190, 0.249166, 0.252139, 0.255109, 0.258077, 0.261043, 0.264006, 0.266967, 0.269925,
		0.272881, 0.275834, 0.278785, 0.281733, 0.284678, 0.287620, 0.290560, 0.293497, 0.296432, 0.299363,
		0.302292, 0.305218, 0.308141, 0.311061, 0.313978, 0.316892, 0.319803, 0.322711, 0.325617, 0.328519,
		0.331418, 0.334313, 0.337206, 0.340096, 0.342982, 0.345865, 0.348745, 0.351621, 0.354494, 0.357364,
		0.360231, 0.363094, 0.365954, 0.368810, 0.371662, 0.374512, 0.377357, 0.380200, 0.383038, 0.385873,
		0.388704, 0.391532, 0.394356, 0.397176, 0.399993, 0.402805, 0.405614, 0.408419, 0.411220, 0.414018,
		0.416811, 0.419601, 0.422386, 0.425168, 0.427945, 0.430719, 0.433488, 0.436254, 0.439015, 0.441772,
		0.444525, 0.447274, 0.450018, 0.452759, 0.455495, 0.458227, 0.460954, 0.463677, 0.466396, 0.469110,
		0.471820, 0.474525, 0.477226, 0.479923, 0.482615, 0.485302, 0.487985, 0.490663, 0.493337, 0.496005,
		0.498670, 0.501329, 0.503984, 0.506634, 0.509279, 0.511920, 0.514555, 0.517186, 0.519812, 0.522433,
		0.525049, 0.527660, 0.530266, 0.532868, 0.535464, 0.538055, 0.540641, 0.543222, 0.545798, 0.548368,
		0.550934, 0.553494, 0.556049, 0.558599, 0.561143, 0.563682, 0.566216, 0.568745, 0.571268, 0.573786,
		0.576298, 0.578805, 0.581307, 0.583803, 0.586294, 0.588779, 0.591258, 0.593732, 0.596200, 0.598663,
		0.601120, 0.603571, 0.606017, 0.608457, 0.610891, 0.613319, 0.615742, 0.618159, 0.620570, 0.622975,
		0.625374, 0.627768, 0.630155, 0.632537, 0.634912, 0.637282, 0.639646, 0.642003, 0.644355, 0.646700,
		0.649039, 0.651372, 0.653700, 0.656020, 0.658335, 0.660644, 0.662946, 0.665242, 0.667532, 0.669815,
		0.672092, 0.674363, 0.676627, 0.678885, 0.681137, 0.683382, 0.685621, 0.687853, 0.690079, 0.692298,
		0.694511, 0.696717, 0.698917, 0.701110, 0.703296, 0.705476, 0.707649, 0.709816, 0.711976, 0.714129,
		0.716275, 0.718415, 0.720548, 0.722674, 0.724793, 0.726905, 0.729011, 0.731109, 0.733201, 0.735286,
		0.737364, 0.739435, 0.741499, 0.743556, 0.745606, 0.747649, 0.749684, 0.751713, 0.753735, 0.755750,
		0.757757, 0.759757, 0.761751, 0.763737, 0.765715, 0.767687, 0.769651, 0.771608, 0.773558, 0.775501,
		0.777436, 0.779364, 0.781284, 0.783197, 0.785103, 0.787001, 0.788892, 0.790776, 0.792652, 0.794520,
		0.796381, 0.798235, 0.800081, 0.801919, 0.803750, 0.805574, 0.807389, 0.809197, 0.810998, 0.812791,
		0.814576, 0.816353, 0.818123, 0.819885, 0.821640, 0.823386, 0.825125, 0.826856, 0.828579, 0.830295,
		0.832002, 0.833702, 0.835394, 0.837078, 0.838754, 0.840422, 0.842083, 0.843735, 0.845379, 0.847016,
		0.848644, 0.850265, 0.851877, 0.853481, 0.855078, 0.856666, 0.858246, 0.859818, 0.861382, 0.862938,
		0.864486, 0.866025, 0.867557, 0.869080, 0.870595, 0.872102, 0.873600, 0.875091, 0.876573, 0.878047,
		0.879512, 0.880969, 0.882418, 0.883859, 0.885291, 0.886715, 0.888131, 0.889538, 0.890937, 0.892327,
		0.893709, 0.895083, 0.896448, 0.897805, 0.899153, 0.900492, 0.901824, 0.903146, 0.904461, 0.905766,
		0.907063, 0.908352, 0.909632, 0.910903, 0.912166, 0.913421, 0.914666, 0.915903, 0.917131, 0.918351,
		0.919562, 0.920765, 0.921958, 0.923143, 0.924320, 0.925487, 0.926646, 0.927796, 0.928938, 0.930070,
		0.931194, 0.932309, 0.933415, 0.934513, 0.935601, 0.936681, 0.937752, 0.938814, 0.939868, 0.940912,
		0.941948, 0.942974, 0.943992, 0.945001, 0.946001, 0.946992, 0.947974, 0.948947, 0.949911, 0.950867,
		0.951813, 0.952750, 0.953678, 0.954598, 0.955508, 0.956409, 0.957302, 0.958185, 0.959059, 0.959924,
		0.960781, 0.961628, 0.962466, 0.963295, 0.964114, 0.964925, 0.965727, 0.966519, 0.967303, 0.968077,
		0.968842, 0.969598, 0.970345, 0.971083, 0.971812, 0.972531, 0.973241, 0.973942, 0.974634, 0.975317,
		0.975990, 0.976655, 0.977310, 0.977956, 0.978592, 0.979220, 0.979838, 0.980447, 0.981047, 0.981637,
		0.982218, 0.982790, 0.983353, 0.983906, 0.984450, 0.984985, 0.985511, 0.986027, 0.986534, 0.987031,
		0.987520, 0.987999, 0.988468, 0.988929, 0.989380, 0.989821, 0.990254, 0.990677, 0.991091, 0.991495,
		0.991890, 0.992276, 0.992652, 0.993019, 0.993376, 0.993724, 0.994063, 0.994393, 0.994713, 0.995023,
		0.995325, 0.995617, 0.995899, 0.996172, 0.996436, 0.996690, 0.996935, 0.997171, 0.997397, 0.997614,
		0.997821, 0.998019, 0.998208, 0.998387, 0.998556, 0.998717, 0.998867, 0.999009, 0.999141, 0.999263,
		0.999376, 0.999480, 0.999574, 0.999659, 0.999735, 0.999801, 0.999857, 0.999905, 0.999942, 0.999971,
		0.999989, 0.999999, 0.999999, 0.999989, 0.999971, 0.999942, 0.999905, 0.999857, 0.999801, 0.999735,
		0.999659, 0.999574, 0.999480, 0.999376, 0.999263, 0.999141, 0.999009, 0.998867, 0.998717, 0.998556,
		0.998387, 0.998208, 0.998019, 0.997821, 0.997614, 0.997397, 0.997171, 0.996935, 0.996690, 0.996436,
		0.996172, 0.995899, 0.995617, 0.995325, 0.995023, 0.994713, 0.994393, 0.994063, 0.993724, 0.993376,
		0.993019, 0.992652, 0.992276, 0.991890, 0.991495, 0.991091, 0.990677, 0.990254, 0.989821, 0.989380,
		0.988929, 0.988468, 0.987999, 0.987520, 0.987031, 0.986534, 0.986027, 0.985511, 0.984985, 0.984450,
		0.983906, 0.983353, 0.982790, 0.982218, 0.981637, 0.981047, 0.980447, 0.979838, 0.979220, 0.978592,
		0.977956, 0.977310, 0.976655, 0.975990, 0.975317, 0.974634, 0.973942, 0.973241, 0.972531, 0.971812,
		0.971083, 0.970345, 0.969598, 0.968842, 0.968077, 0.967303, 0.966519, 0.965727, 0.964925, 0.964114,
		0.963295, 0.962466, 0.961628, 0.960781, 0.959924, 0.959059, 0.958185, 0.957302, 0.956409, 0.955508,
		0.954598, 0.953678, 0.952750, 0.951813, 0.950867, 0.949911, 0.948947, 0.947974, 0.946992, 0.946001,
		0.945001, 0.943992, 0.942974, 0.941948, 0.940912, 0.939868, 0.938814, 0.937752, 0.936681, 0.935601,
		0.934513, 0.933415, 0.932309, 0.931194, 0.930070, 0.928938, 0.927796, 0.926646, 0.925487, 0.924320,
		0.923143, 0.921958, 0.920765, 0.919562, 0.918351, 0.917131, 0.915903, 0.914666, 0.913421, 0.912166,
		0.910903, 0.909632, 0.908352, 0.907063, 0.905766, 0.904461, 0.903146, 0.901824, 0.900492, 0.899153,
		0.897805, 0.896448, 0.895083, 0.893709, 0.892327, 0.890937, 0.889538, 0.888131, 0.886715, 0.885291,
		0.883859, 0.882418, 0.880969, 0.879512, 0.878047, 0.876573, 0.875091, 0.873600, 0.872102, 0.870595,
		0.869080, 0.867557, 0.866025, 0.864486, 0.862938, 0.861382, 0.859818, 0.858246, 0.856666, 0.855078,
		0.853481, 0.851877, 0.850265, 0.848644, 0.847016, 0.845379, 0.843735, 0.842083, 0.840422, 0.838754,
		0.837078, 0.835394, 0.833702, 0.832002, 0.830295, 0.828579, 0.826856, 0.825125, 0.823386, 0.821640,
		0.819885, 0.818123, 0.816353, 0.814576, 0.812791, 0.810998, 0.809197, 0.807389, 0.805574, 0.803750,
		0.801919, 0.800081, 0.798235, 0.796381, 0.794520, 0.792652, 0.790776, 0.788892, 0.787001, 0.785103,
		0.783197, 0.781284, 0.779364, 0.777436, 0.775501, 0.773558, 0.771608, 0.769651, 0.767687, 0.765715,
		0.763737, 0.761751, 0.759757, 0.757757, 0.755750, 0.753735, 0.751713, 0.749684, 0.747649, 0.745606,
		0.743556, 0.741499, 0.739435, 0.737364, 0.735286, 0.733201, 0.731109, 0.729011, 0.726905, 0.724793,
		0.722674, 0.720548, 0.718415, 0.716275, 0.714129, 0.711976, 0.709816, 0.707649, 0.705476, 0.703296,
		0.701110, 0.698917, 0.696717, 0.694511, 0.692298, 0.690079, 0.687853, 0.685621, 0.683382, 0.681137,
		0.678885, 0.676627, 0.674363, 0.672092, 0.669815, 0.667532, 0.665242, 0.662946, 0.660644, 0.658335,
		0.656020, 0.653700, 0.651372, 0.649039, 0.646700, 0.644355, 0.642003, 0.639646, 0.637282, 0.634912,
		0.632537, 0.630155, 0.627768, 0.625374, 0.622975, 0.620570, 0.618159, 0.615742, 0.613319, 0.610891,
		0.608457, 0.606017, 0.603571, 0.601120, 0.598663, 0.596200, 0.593732, 0.591258, 0.588779, 0.586294,
		0.583803, 0.581307, 0.578805, 0.576298, 0.573786, 0.571268, 0.568745, 0.566216, 0.563682, 0.561143,
		0.558599, 0.556049, 0.553494, 0.550934, 0.548368, 0.545798, 0.543222, 0.540641, 0.538055, 0.535464,
		0.532868, 0.530266, 0.527660, 0.525049, 0.522433, 0.519812, 0.517186, 0.514555, 0.511920, 0.509279,
		0.506634, 0.503984, 0.501329, 0.498670, 0.496005, 0.493337, 0.490663, 0.487985, 0.485302, 0.482615,
		0.479923, 0.477226, 0.474525, 0.471820, 0.469110, 0.466396, 0.463677, 0.460954, 0.458227, 0.455495,
		0.452759, 0.450018, 0.447274, 0.444525, 0.441772, 0.439015, 0.436254, 0.433488, 0.430719, 0.427945,
		0.425168, 0.422386, 0.419601, 0.416811, 0.414018, 0.411220, 0.408419, 0.405614, 0.402805, 0.399993,
		0.397176, 0.394356, 0.391532, 0.388704, 0.385873, 0.383038, 0.380200, 0.377357, 0.374512, 0.371662,
		0.368810, 0.365954, 0.363094, 0.360231, 0.357364, 0.354494, 0.351621, 0.348745, 0.345865, 0.342982,
		0.340096, 0.337206, 0.334313, 0.331418, 0.328519, 0.325617, 0.322711, 0.319803, 0.316892, 0.313978,
		0.311061, 0.308141, 0.305218, 0.302292, 0.299363, 0.296432, 0.293497, 0.290560, 0.287620, 0.284678,
		0.281733, 0.278785, 0.275834, 0.272881, 0.269925, 0.266967, 0.264006, 0.261043, 0.258077, 0.255109,
		0.252139, 0.249166, 0.246190, 0.243213, 0.240233, 0.237251, 0.234266, 0.231280, 0.228291, 0.225300,
		0.222307, 0.219312, 0.216315, 0.213315, 0.210314, 0.207311, 0.204306, 0.201299, 0.198289, 0.195279,
		0.192266, 0.189251, 0.186235, 0.183217, 0.180197, 0.177175, 0.174152, 0.171127, 0.168101, 0.165073,
		0.162043, 0.159012, 0.155979, 0.152945, 0.149910, 0.146873, 0.143835, 0.140795, 0.137754, 0.134711,
		0.131668, 0.128623, 0.125577, 0.122530, 0.119481, 0.116432, 0.113381, 0.110330, 0.107277, 0.104223,
		0.101168, 0.098113, 0.095056, 0.091999, 0.088940, 0.085881, 0.082821, 0.079760, 0.076699, 0.073636,
		0.070573, 0.067510, 0.064445, 0.061381, 0.058315, 0.055249, 0.052183, 0.049116, 0.046048, 0.042980,
		0.039912, 0.036843, 0.033774, 0.030705, 0.027635, 0.024565, 0.021495, 0.018425, 0.015354, 0.012284
		};

	for(i = 0; i < FFTSAMPLES; i++){
		input[i] *= lookup_table[i];
	}
}

void velocity_conversion_display(float *peak_index)
{
	char lcd_str[8] = {0};
	float scale = 1241.379;
	float normalized_freq = (*peak_index)/(FFTSAMPLES*2);
	clear_screen();
	sprintf(lcd_str, "%.2f   ", normalized_freq * scale);
	//sprintf(lcd_str, "%.1f", *peak_index);
	BSP_LCD_GLASS_DisplayString((uint8_t *)lcd_str);
}

void clear_screen(void)
{
	BSP_LCD_GLASS_DisplayString((uint8_t *)"        ");
}

void decimate(int blocksize, int decimation, float *input, float *output)
{
	int i;

	for (i = 0; i < blocksize/decimation; i++){  //Only keep every fifth sample
		output[i] = input[i*decimation];
	}
}
