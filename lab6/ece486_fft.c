/*!
 * @file fsk_rt.c
 *
 * @brief
 *
 * @author ECE486 Lab Group 9
 * @author Colin Leary
 * @author Forrest Smith
 * @author Sean Turner
 *
 * @date April 23, 2016
 *
 */
#include <stdlib.h>
#include <stdint.h>
#include <math.h>
#include "arm_math.h"
#include "arm_const_structs.h"
#include "ece486_fft.h"
#include "ece486.h"
#include "init486.h"

int peak_detect(float *data, float thresh, int button_flag)
{
	int i;


	// This assumes that 0-.5 is positive freqs and .5 - 1 is negative freqs
	if(button_flag == 1){
		for (i = (FFTSAMPLES/3)-1; i > 38 ; i--) {
			if ((data[i] >= thresh) && (data[i-1] < data[i]) && (data[i+1] < data[i])){
				return i;
			}
		}
	}

	if(button_flag == -1){
		for (i = (2*FFTSAMPLES/3) + 1; i < 986; i++) {
			if ((data[i] >= thresh) && (data[i-1] < data[i]) && (data[i+1] < data[i])){
				return i;
			}
		}
	}

	return -1;
}


void fft(float *buffer, float thresh, float *peak_index, int button_flag)
{
	int i;
	static float output[FFTSAMPLES] = {0};
	int ifftFlag = 0;
	int doBitReverse = 1;
	float maxvalue = 0 ;
	uint32_t index = 0;

	window(buffer);
	arm_cfft_f32(&arm_cfft_sR_f32_len1024, buffer, ifftFlag, doBitReverse);

	arm_cmplx_mag_f32(buffer, output, FFTSAMPLES);

	*peak_index = peak_detect(output, thresh, button_flag);
}

//multiply by 1024 samples of a half period of sine, as a window function
void window(float *input)
{
	int i;

	float lookup_table[1024] =
	{
		0.000355, 0.000391, 0.000428, 0.000467, 0.000508, 0.000550, 0.000594, 0.000641, 0.000689, 0.000739,
		0.000792, 0.000846, 0.000903, 0.000962, 0.001023, 0.001086, 0.001152, 0.001220, 0.001291, 0.001365,
		0.001441, 0.001519, 0.001601, 0.001685, 0.001772, 0.001862, 0.001955, 0.002051, 0.002150, 0.002253,
		0.002359, 0.002468, 0.002580, 0.002696, 0.002815, 0.002938, 0.003065, 0.003195, 0.003329, 0.003467,
		0.003610, 0.003756, 0.003906, 0.004060, 0.004219, 0.004382, 0.004549, 0.004721, 0.004898, 0.005079,
		0.005265, 0.005456, 0.005652, 0.005852, 0.006058, 0.006269, 0.006485, 0.006707, 0.006934, 0.007166,
		0.007404, 0.007648, 0.007897, 0.008153, 0.008414, 0.008681, 0.008955, 0.009235, 0.009521, 0.009813,
		0.010112, 0.010418, 0.010730, 0.011049, 0.011375, 0.011708, 0.012048, 0.012395, 0.012750, 0.013112,
		0.013481, 0.013858, 0.014243, 0.014636, 0.015036, 0.015444, 0.015861, 0.016285, 0.016718, 0.017160,
		0.017609, 0.018068, 0.018535, 0.019011, 0.019496, 0.019990, 0.020493, 0.021005, 0.021526, 0.022058,
		0.022598, 0.023148, 0.023708, 0.024278, 0.024858, 0.025448, 0.026048, 0.026659, 0.027279, 0.027911,
		0.028553, 0.029205, 0.029869, 0.030543, 0.031229, 0.031926, 0.032634, 0.033353, 0.034084, 0.034826,
		0.035580, 0.036346, 0.037124, 0.037914, 0.038716, 0.039530, 0.040356, 0.041195, 0.042047, 0.042911,
		0.043788, 0.044678, 0.045581, 0.046496, 0.047425, 0.048368, 0.049323, 0.050292, 0.051275, 0.052271,
		0.053282, 0.054306, 0.055344, 0.056396, 0.057462, 0.058543, 0.059638, 0.060747, 0.061871, 0.063010,
		0.064163, 0.065332, 0.066515, 0.067713, 0.068926, 0.070155, 0.071399, 0.072658, 0.073933, 0.075224,
		0.076530, 0.077851, 0.079189, 0.080543, 0.081912, 0.083298, 0.084700, 0.086118, 0.087552, 0.089003,
		0.090470, 0.091953, 0.093454, 0.094971, 0.096505, 0.098055, 0.099623, 0.101207, 0.102809, 0.104427,
		0.106063, 0.107716, 0.109386, 0.111074, 0.112778, 0.114501, 0.116241, 0.117998, 0.119773, 0.121566,
		0.123376, 0.125204, 0.127050, 0.128914, 0.130796, 0.132695, 0.134613, 0.136548, 0.138502, 0.140473,
		0.142463, 0.144471, 0.146497, 0.148541, 0.150603, 0.152684, 0.154782, 0.156899, 0.159035, 0.161188,
		0.163360, 0.165550, 0.167759, 0.169985, 0.172230, 0.174494, 0.176776, 0.179076, 0.181394, 0.183731,
		0.186086, 0.188459, 0.190851, 0.193261, 0.195689, 0.198135, 0.200600, 0.203083, 0.205584, 0.208103,
		0.210640, 0.213195, 0.215769, 0.218360, 0.220969, 0.223596, 0.226242, 0.228904, 0.231585, 0.234284,
		0.237000, 0.239733, 0.242485, 0.245253, 0.248040, 0.250843, 0.253664, 0.256502, 0.259358, 0.262230,
		0.265119, 0.268026, 0.270949, 0.273889, 0.276846, 0.279819, 0.282809, 0.285815, 0.288837, 0.291876,
		0.294931, 0.298001, 0.301088, 0.304190, 0.307308, 0.310442, 0.313591, 0.316755, 0.319935, 0.323130,
		0.326339, 0.329564, 0.332803, 0.336057, 0.339325, 0.342607, 0.345903, 0.349214, 0.352538, 0.355876,
		0.359228, 0.362593, 0.365971, 0.369362, 0.372766, 0.376183, 0.379613, 0.383055, 0.386509, 0.389975,
		0.393453, 0.396943, 0.400445, 0.403957, 0.407481, 0.411016, 0.414562, 0.418118, 0.421685, 0.425262,
		0.428849, 0.432445, 0.436052, 0.439668, 0.443293, 0.446927, 0.450569, 0.454221, 0.457880, 0.461548,
		0.465224, 0.468907, 0.472598, 0.476296, 0.480002, 0.483714, 0.487432, 0.491157, 0.494888, 0.498625,
		0.502367, 0.506115, 0.509867, 0.513625, 0.517388, 0.521154, 0.524925, 0.528700, 0.532478, 0.536260,
		0.540045, 0.543833, 0.547623, 0.551416, 0.555211, 0.559007, 0.562806, 0.566605, 0.570405, 0.574207,
		0.578008, 0.581810, 0.585612, 0.589413, 0.593214, 0.597014, 0.600813, 0.604610, 0.608406, 0.612199,
		0.615990, 0.619779, 0.623564, 0.627347, 0.631126, 0.634901, 0.638673, 0.642440, 0.646202, 0.649960,
		0.653712, 0.657459, 0.661200, 0.664935, 0.668663, 0.672385, 0.676100, 0.679808, 0.683508, 0.687201,
		0.690885, 0.694561, 0.698228, 0.701886, 0.705534, 0.709173, 0.712803, 0.716422, 0.720030, 0.723628,
		0.727214, 0.730789, 0.734352, 0.737904, 0.741443, 0.744969, 0.748483, 0.751983, 0.755470, 0.758943,
		0.762402, 0.765847, 0.769276, 0.772691, 0.776091, 0.779475, 0.782843, 0.786195, 0.789531, 0.792850,
		0.796152, 0.799437, 0.802704, 0.805953, 0.809184, 0.812396, 0.815590, 0.818765, 0.821921, 0.825056,
		0.828173, 0.831269, 0.834344, 0.837399, 0.840433, 0.843445, 0.846437, 0.849406, 0.852353, 0.855278,
		0.858181, 0.861060, 0.863917, 0.866750, 0.869559, 0.872345, 0.875106, 0.877844, 0.880556, 0.883244,
		0.885906, 0.888543, 0.891154, 0.893740, 0.896299, 0.898832, 0.901339, 0.903819, 0.906271, 0.908696,
		0.911094, 0.913464, 0.915807, 0.918120, 0.920406, 0.922663, 0.924891, 0.927090, 0.929260, 0.931401,
		0.933511, 0.935592, 0.937643, 0.939664, 0.941654, 0.943614, 0.945543, 0.947440, 0.949307, 0.951142,
		0.952946, 0.954718, 0.956458, 0.958167, 0.959843, 0.961486, 0.963097, 0.964676, 0.966221, 0.967734,
		0.969213, 0.970660, 0.972072, 0.973452, 0.974797, 0.976109, 0.977387, 0.978631, 0.979841, 0.981016,
		0.982157, 0.983263, 0.984335, 0.985372, 0.986375, 0.987342, 0.988274, 0.989172, 0.990034, 0.990860,
		0.991652, 0.992408, 0.993128, 0.993813, 0.994462, 0.995075, 0.995653, 0.996195, 0.996701, 0.997171,
		0.997605, 0.998003, 0.998365, 0.998691, 0.998981, 0.999234, 0.999452, 0.999633, 0.999778, 0.999887,
		0.999959, 0.999995, 0.999995, 0.999959, 0.999887, 0.999778, 0.999633, 0.999452, 0.999234, 0.998981,
		0.998691, 0.998365, 0.998003, 0.997605, 0.997171, 0.996701, 0.996195, 0.995653, 0.995075, 0.994462,
		0.993813, 0.993128, 0.992408, 0.991652, 0.990860, 0.990034, 0.989172, 0.988274, 0.987342, 0.986375,
		0.985372, 0.984335, 0.983263, 0.982157, 0.981016, 0.979841, 0.978631, 0.977387, 0.976109, 0.974797,
		0.973452, 0.972072, 0.970660, 0.969213, 0.967734, 0.966221, 0.964676, 0.963097, 0.961486, 0.959843,
		0.958167, 0.956458, 0.954718, 0.952946, 0.951142, 0.949307, 0.947440, 0.945543, 0.943614, 0.941654,
		0.939664, 0.937643, 0.935592, 0.933511, 0.931401, 0.929260, 0.927090, 0.924891, 0.922663, 0.920406,
		0.918120, 0.915807, 0.913464, 0.911094, 0.908696, 0.906271, 0.903819, 0.901339, 0.898832, 0.896299,
		0.893740, 0.891154, 0.888543, 0.885906, 0.883244, 0.880556, 0.877844, 0.875106, 0.872345, 0.869559,
		0.866750, 0.863917, 0.861060, 0.858181, 0.855278, 0.852353, 0.849406, 0.846437, 0.843445, 0.840433,
		0.837399, 0.834344, 0.831269, 0.828173, 0.825056, 0.821921, 0.818765, 0.815590, 0.812396, 0.809184,
		0.805953, 0.802704, 0.799437, 0.796152, 0.792850, 0.789531, 0.786195, 0.782843, 0.779475, 0.776091,
		0.772691, 0.769276, 0.765847, 0.762402, 0.758943, 0.755470, 0.751983, 0.748483, 0.744969, 0.741443,
		0.737904, 0.734352, 0.730789, 0.727214, 0.723628, 0.720030, 0.716422, 0.712803, 0.709173, 0.705534,
		0.701886, 0.698228, 0.694561, 0.690885, 0.687201, 0.683508, 0.679808, 0.676100, 0.672385, 0.668663,
		0.664935, 0.661200, 0.657459, 0.653712, 0.649960, 0.646202, 0.642440, 0.638673, 0.634901, 0.631126,
		0.627347, 0.623564, 0.619779, 0.615990, 0.612199, 0.608406, 0.604610, 0.600813, 0.597014, 0.593214,
		0.589413, 0.585612, 0.581810, 0.578008, 0.574207, 0.570405, 0.566605, 0.562806, 0.559007, 0.555211,
		0.551416, 0.547623, 0.543833, 0.540045, 0.536260, 0.532478, 0.528700, 0.524925, 0.521154, 0.517388,
		0.513625, 0.509867, 0.506115, 0.502367, 0.498625, 0.494888, 0.491157, 0.487432, 0.483714, 0.480002,
		0.476296, 0.472598, 0.468907, 0.465224, 0.461548, 0.457880, 0.454221, 0.450569, 0.446927, 0.443293,
		0.439668, 0.436052, 0.432445, 0.428849, 0.425262, 0.421685, 0.418118, 0.414562, 0.411016, 0.407481,
		0.403957, 0.400445, 0.396943, 0.393453, 0.389975, 0.386509, 0.383055, 0.379613, 0.376183, 0.372766,
		0.369362, 0.365971, 0.362593, 0.359228, 0.355876, 0.352538, 0.349214, 0.345903, 0.342607, 0.339325,
		0.336057, 0.332803, 0.329564, 0.326339, 0.323130, 0.319935, 0.316755, 0.313591, 0.310442, 0.307308,
		0.304190, 0.301088, 0.298001, 0.294931, 0.291876, 0.288837, 0.285815, 0.282809, 0.279819, 0.276846,
		0.273889, 0.270949, 0.268026, 0.265119, 0.262230, 0.259358, 0.256502, 0.253664, 0.250843, 0.248040,
		0.245253, 0.242485, 0.239733, 0.237000, 0.234284, 0.231585, 0.228904, 0.226242, 0.223596, 0.220969,
		0.218360, 0.215769, 0.213195, 0.210640, 0.208103, 0.205584, 0.203083, 0.200600, 0.198135, 0.195689,
		0.193261, 0.190851, 0.188459, 0.186086, 0.183731, 0.181394, 0.179076, 0.176776, 0.174494, 0.172230,
		0.169985, 0.167759, 0.165550, 0.163360, 0.161188, 0.159035, 0.156899, 0.154782, 0.152684, 0.150603,
		0.148541, 0.146497, 0.144471, 0.142463, 0.140473, 0.138502, 0.136548, 0.134613, 0.132695, 0.130796,
		0.128914, 0.127050, 0.125204, 0.123376, 0.121566, 0.119773, 0.117998, 0.116241, 0.114501, 0.112778,
		0.111074, 0.109386, 0.107716, 0.106063, 0.104427, 0.102809, 0.101207, 0.099623, 0.098055, 0.096505,
		0.094971, 0.093454, 0.091953, 0.090470, 0.089003, 0.087552, 0.086118, 0.084700, 0.083298, 0.081912,
		0.080543, 0.079189, 0.077851, 0.076530, 0.075224, 0.073933, 0.072658, 0.071399, 0.070155, 0.068926,
		0.067713, 0.066515, 0.065332, 0.064163, 0.063010, 0.061871, 0.060747, 0.059638, 0.058543, 0.057462,
		0.056396, 0.055344, 0.054306, 0.053282, 0.052271, 0.051275, 0.050292, 0.049323, 0.048368, 0.047425,
		0.046496, 0.045581, 0.044678, 0.043788, 0.042911, 0.042047, 0.041195, 0.040356, 0.039530, 0.038716,
		0.037914, 0.037124, 0.036346, 0.035580, 0.034826, 0.034084, 0.033353, 0.032634, 0.031926, 0.031229,
		0.030543, 0.029869, 0.029205, 0.028553, 0.027911, 0.027279, 0.026659, 0.026048, 0.025448, 0.024858,
		0.024278, 0.023708, 0.023148, 0.022598, 0.022058, 0.021526, 0.021005, 0.020493, 0.019990, 0.019496,
		0.019011, 0.018535, 0.018068, 0.017609, 0.017160, 0.016718, 0.016285, 0.015861, 0.015444, 0.015036,
		0.014636, 0.014243, 0.013858, 0.013481, 0.013112, 0.012750, 0.012395, 0.012048, 0.011708, 0.011375,
		0.011049, 0.010730, 0.010418, 0.010112, 0.009813, 0.009521, 0.009235, 0.008955, 0.008681, 0.008414,
		0.008153, 0.007897, 0.007648, 0.007404, 0.007166, 0.006934, 0.006707, 0.006485, 0.006269, 0.006058,
		0.005852, 0.005652, 0.005456, 0.005265, 0.005079, 0.004898, 0.004721, 0.004549, 0.004382, 0.004219,
		0.004060, 0.003906, 0.003756, 0.003610, 0.003467, 0.003329, 0.003195, 0.003065, 0.002938, 0.002815,
		0.002696, 0.002580, 0.002468, 0.002359, 0.002253, 0.002150, 0.002051, 0.001955, 0.001862, 0.001772,
		0.001685, 0.001601, 0.001519, 0.001441, 0.001365, 0.001291, 0.001220, 0.001152, 0.001086, 0.001023,
		0.000962, 0.000903, 0.000846, 0.000792, 0.000739, 0.000689, 0.000641, 0.000594, 0.000550, 0.000508
};

	for(i = 0; i < FFTSAMPLES; i++){
		input[2*i] *= lookup_table[i];
		input[2*i+1] *= lookup_table[i];
	}
}

void velocity_conversion_display(float *peak_index, int button_flag)
{
	clear_screen();
	if( *peak_index == -1){
		BSP_LCD_GLASS_DisplayString((uint8_t *)"No");
		return;
	}
	char lcd_str[8] = {0};
	float scale =  .1515; //(6e3/1024/2/5.8e9*3e8)
	if( button_flag == 1) sprintf(lcd_str, "-%.1f", *peak_index * scale);
	if( button_flag == -1) sprintf(lcd_str, "%.1f", (FFTSAMPLES-*peak_index) * scale);
	BSP_LCD_GLASS_DisplayString((uint8_t *)lcd_str);

}

void clear_screen(void)
{
	BSP_LCD_GLASS_DisplayString((uint8_t *)"        ");
}
