/*!
 * @file fsk_rt.c
 *
 * @brief
 *
 * @author ECE486 Lab Group 9
 * @author Colin Leary
 * @author Forrest Smith
 * @author Sean Turner
 *
 * @date April 23, 2016
 *
 */

#include "arm_math.h"
#include "arm_const_structs.h"
#include "ece486_fft.h"

int peak_detect(float *data, float thresh, int *peaks, int farthest_peak_index)
{
	int i, count, index = 0;

	for (i = 1; i < FFTSAMPLES-1; i++) {
		if (data[i] >= thresh && data[i-1] < data[i] && data[i+1] < data[i])
			peaks[count++] = i+1;
	}

	for(i = 1; i < count; i++){
		if( peaks[i] > index) peaks[i] = index;
	}

	farthest_peak_index = index;

	return count;

}


void fft(float *input_real, float *input_complex, float thresh, int peak_index)
{
	int i;
	static float tmp[FFTSAMPLES*2];
	static float output[FFTSAMPLES];
	static int peaks[10];//detects 10 peaks
	int ifftFlag = 0;
	int doBitReverse = 1;
	int count;


	for(i = 0; i < FFTSAMPLES; i++){
		tmp[i] = input_real[i];
	}

	for(i = 0; i < FFTSAMPLES; i++){
		tmp[i + FFTSAMPLES] = input_complex[i];
	}


	//set up for a 512 blocksize and fft of 1024
	arm_cfft_f32(&arm_cfft_sR_f32_len1024, tmp, ifftFlag, doBitReverse);
	arm_cmplx_mag_f32(tmp, output, FFTSAMPLES*2);
	count = peak_detect(output, thresh, peaks, peak_index);

}

//multiply by 512 samples of a half period of sine, as a window function
void window(float *input)
{
	int i;

	static float lookup_table[512] = {0.000000, 0.061441, 0.122649, 0.183394, 0.243446, 0.302578, 0.360567, 0.417194, 0.472244, 0.525509,
0.006148, 0.067576, 0.128748, 0.189434, 0.249404, 0.308432, 0.366295, 0.422773, 0.477654, 0.530730,
0.012296, 0.073708, 0.134842, 0.195467, 0.255353, 0.314275, 0.372008, 0.428336, 0.483046, 0.535931,
0.018443, 0.079838, 0.140932, 0.201493, 0.261293, 0.320105, 0.377708, 0.433884, 0.488420, 0.541111,
0.024589, 0.085965, 0.147016, 0.207511, 0.267222, 0.325923, 0.383393, 0.439415, 0.493776, 0.546271,
0.030735, 0.092088, 0.153094, 0.213521, 0.273141, 0.331729, 0.389064, 0.444929, 0.499112, 0.551410,
0.036879, 0.098208, 0.159166, 0.219523, 0.279050, 0.337523, 0.394720, 0.450426, 0.504430, 0.556528,
0.043022, 0.104325, 0.165233, 0.225517, 0.284949, 0.343304, 0.400362, 0.455907, 0.509729, 0.561626,
0.049164, 0.110437, 0.171293, 0.231502, 0.290836, 0.349071, 0.405988, 0.461370, 0.515009, 0.566702,
0.055303, 0.116545, 0.177347, 0.237479, 0.296713, 0.354826, 0.411598, 0.466816, 0.520269, 0.571756,
0.061441, 0.122649, 0.183394, 0.243446, 0.302578, 0.360567, 0.417194, 0.472244, 0.525509, 0.576790,
0.067576, 0.128748, 0.189434, 0.249404, 0.308432, 0.366295, 0.422773, 0.477654, 0.530730, 0.581801,
0.073708, 0.134842, 0.195467, 0.255353, 0.314275, 0.372008, 0.428336, 0.483046, 0.535931, 0.586790,
0.079838, 0.140932, 0.201493, 0.261293, 0.320105, 0.377708, 0.433884, 0.488420, 0.541111, 0.591757,
0.085965, 0.147016, 0.207511, 0.267222, 0.325923, 0.383393, 0.439415, 0.493776, 0.546271, 0.596702,
0.092088, 0.153094, 0.213521, 0.273141, 0.331729, 0.389064, 0.444929, 0.499112, 0.551410, 0.601624,
0.098208, 0.159166, 0.219523, 0.279050, 0.337523, 0.394720, 0.450426, 0.504430, 0.556528, 0.606524,
0.104325, 0.165233, 0.225517, 0.284949, 0.343304, 0.400362, 0.455907, 0.509729, 0.561626, 0.611400,
0.110437, 0.171293, 0.231502, 0.290836, 0.349071, 0.405988, 0.461370, 0.515009, 0.566702, 0.616253,
0.116545, 0.177347, 0.237479, 0.296713, 0.354826, 0.411598, 0.466816, 0.520269, 0.571756, 0.621084,
0.122649, 0.183394, 0.243446, 0.302578, 0.360567, 0.417194, 0.472244, 0.525509, 0.576790, 0.625890,
0.128748, 0.189434, 0.249404, 0.308432, 0.366295, 0.422773, 0.477654, 0.530730, 0.581801, 0.630673,
0.134842, 0.195467, 0.255353, 0.314275, 0.372008, 0.428336, 0.483046, 0.535931, 0.586790, 0.635432,
0.140932, 0.201493, 0.261293, 0.320105, 0.377708, 0.433884, 0.488420, 0.541111, 0.591757, 0.640167,
0.147016, 0.207511, 0.267222, 0.325923, 0.383393, 0.439415, 0.493776, 0.546271, 0.596702, 0.644878,
0.153094, 0.213521, 0.273141, 0.331729, 0.389064, 0.444929, 0.499112, 0.551410, 0.601624, 0.649565,
0.159166, 0.219523, 0.279050, 0.337523, 0.394720, 0.450426, 0.504430, 0.556528, 0.606524, 0.654227,
0.165233, 0.225517, 0.284949, 0.343304, 0.400362, 0.455907, 0.509729, 0.561626, 0.611400, 0.658864,
0.171293, 0.231502, 0.290836, 0.349071, 0.405988, 0.461370, 0.515009, 0.566702, 0.616253, 0.663477,
0.177347, 0.237479, 0.296713, 0.354826, 0.411598, 0.466816, 0.520269, 0.571756, 0.621084, 0.668064,
0.183394, 0.243446, 0.302578, 0.360567, 0.417194, 0.472244, 0.525509, 0.576790, 0.625890, 0.672626,
0.189434, 0.249404, 0.308432, 0.366295, 0.422773, 0.477654, 0.530730, 0.581801, 0.630673, 0.677163,
0.195467, 0.255353, 0.314275, 0.372008, 0.428336, 0.483046, 0.535931, 0.586790, 0.635432, 0.681674,
0.201493, 0.261293, 0.320105, 0.377708, 0.433884, 0.488420, 0.541111, 0.591757, 0.640167, 0.686159,
0.207511, 0.267222, 0.325923, 0.383393, 0.439415, 0.493776, 0.546271, 0.596702, 0.644878, 0.690618,
0.213521, 0.273141, 0.331729, 0.389064, 0.444929, 0.499112, 0.551410, 0.601624, 0.649565, 0.695051,
0.219523, 0.279050, 0.337523, 0.394720, 0.450426, 0.504430, 0.556528, 0.606524, 0.654227, 0.699458,
0.225517, 0.284949, 0.343304, 0.400362, 0.455907, 0.509729, 0.561626, 0.611400, 0.658864, 0.703839,
0.231502, 0.290836, 0.349071, 0.405988, 0.461370, 0.515009, 0.566702, 0.616253, 0.663477, 0.708193,
0.237479, 0.296713, 0.354826, 0.411598, 0.466816, 0.520269, 0.571756, 0.621084, 0.668064, 0.712520,
0.243446, 0.302578, 0.360567, 0.417194, 0.472244, 0.525509, 0.576790, 0.625890, 0.672626, 0.716820,
0.249404, 0.308432, 0.366295, 0.422773, 0.477654, 0.530730, 0.581801, 0.630673, 0.677163, 0.721093,
0.255353, 0.314275, 0.372008, 0.428336, 0.483046, 0.535931, 0.586790, 0.635432, 0.681674, 0.725339,
0.261293, 0.320105, 0.377708, 0.433884, 0.488420, 0.541111, 0.591757, 0.640167, 0.686159, 0.729558,
0.267222, 0.325923, 0.383393, 0.439415, 0.493776, 0.546271, 0.596702, 0.644878, 0.690618, 0.733748,
0.273141, 0.331729, 0.389064, 0.444929, 0.499112, 0.551410, 0.601624, 0.649565, 0.695051, 0.737912,
0.279050, 0.337523, 0.394720, 0.450426, 0.504430, 0.556528, 0.606524, 0.654227, 0.699458, 0.742047,
0.284949, 0.343304, 0.400362, 0.455907, 0.509729, 0.561626, 0.611400, 0.658864, 0.703839, 0.746154,
0.290836, 0.349071, 0.405988, 0.461370, 0.515009, 0.566702, 0.616253, 0.663477, 0.708193, 0.750233,
0.296713, 0.354826, 0.411598, 0.466816, 0.520269, 0.571756, 0.621084, 0.668064, 0.712520, 0.754284,
0.302578, 0.360567, 0.417194, 0.472244, 0.525509, 0.576790, 0.625890, 0.672626, 0.716820, 0.758306
};

	for(i = 0; i < FFTSAMPLES; i++){
		input[i] *= lookup_table[i];
	}
}

void velocity_conversion_display(int peak_index)
{
	float normalized_freq = peak_index/FFTSAMPLES;

	//haven't been able to figure out conversion

}
